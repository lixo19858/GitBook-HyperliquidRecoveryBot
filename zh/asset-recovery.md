# 资产恢复功能

资产恢复是 Hyperliquid Recovery Bot 的核心功能，帮助用户从 Hyperliquid 地址中安全地恢复数字资产。

## 🎯 功能概述

### 恢复原理
机器人通过直接调用 Hyperliquid API 来执行资产转换、转账和提现操作，帮助用户恢复资产。这对于需要从可能受限访问官方前端的地址中转移资产特别有用。

### 恢复流程
1. **资产检测**: 分析现货、永续合约、金库和质押账户中的所有资产
2. **智能转换**: 将非 USDC 资产转换为 USDC 以便于提现
3. **账户转移**: 根据需要在现货和永续合约账户之间转移资产
4. **执行提现**: 将 USDC 提现到 Arbitrum 网络
5. **费用收取**: 根据总恢复价值收取服务费

### 支持的资产类型
- **现货资产**: 直接转换和提现现货账户资产
- **永续合约资产**: 平仓并将保证金转移到现货
- **金库资产**: 从 Hyperliquid 金库提取（如果支持）
- **质押资产**: 解除质押和恢复（如果支持）

## 🚀 使用方法

### 启动恢复功能
```
方法一: 点击主菜单 🛠️ 资产恢复
方法二: 发送 /recovery 命令
方法三: 在检测结果页面点击 [开始恢复]
方法四: 从已导入钱包的钱包详情页面
```

### 完整恢复流程

#### 步骤 1: 地址输入
```
🛠️ 资产恢复功能

请输入您要恢复资产的地址:

💡 提示:
• 使用最近检测结果中的地址
• 从已导入钱包列表中选择
• 输入新的 Hyperliquid 地址

[输入地址] [使用最近] [选择钱包]
```

#### 步骤 2: 资产分析
```
📊 正在分析资产...

🔍 检测到的资产:
• 现货账户: 3 个资产 ($750.00)
• 永续合约账户: 2 个资产 ($485.06)
• 总价值: $1,235.06

📋 恢复计划:
1. 将非 USDC 现货资产转换为 USDC
2. 将所有现货 USDC 转移到永续合约账户
3. 将非 USDC 永续合约资产转换为 USDC
4. 将所有 USDC 提现到 Arbitrum

💰 服务费: $6.18 (0.5%)
💵 净恢复金额: $1,228.88

[继续] [取消]
```

#### 步骤 3: 私钥输入
```
🔐 私钥验证

请输入此地址的私钥:

⚠️ 安全提示:
• 私钥仅用于恢复操作
• 完成后自动从内存中清除
• 确保您处于安全环境中
• 切勿分享或截图您的私钥

格式: 64 位十六进制字符（可带或不带 0x 前缀）
示例: 1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef

[输入私钥] [取消]
```

#### 步骤 4: 私钥验证
```
🔍 正在验证私钥...

✅ 私钥格式有效
✅ 地址匹配确认
✅ 账户访问验证通过

继续执行恢复...
```

#### 步骤 5: 恢复执行
```
🚀 正在执行恢复计划...

步骤 1/4: 转换现货资产
🔄 正在将 ETH 转换为 USDC...
✅ ETH 转换完成: 0.5 ETH → 734.56 USDC
🔄 正在将 BTC 转换为 USDC...
✅ BTC 转换完成: 0.001 BTC → 45.00 USDC

步骤 2/4: 转移到永续合约账户
🔄 正在将 1,279.56 USDC 从现货转移到永续合约...
✅ 转移完成

步骤 3/4: 转换永续合约资产
🔄 正在平仓 ETH-USD 持仓...
✅ 持仓平仓完成: +0.1 ETH 已实现
🔄 正在转换额外的 ETH 为 USDC...
✅ 转换完成: 0.1 ETH → 147.12 USDC

步骤 4/4: 最终提现
🔄 正在将 1,420.50 USDC 提现到 Arbitrum...
💰 已扣除服务费: 7.10 USDC
✅ 提现完成: 1,413.40 USDC

🎉 恢复成功完成！
```

#### 步骤 6: 恢复结果
```
✅ 资产恢复成功！

📊 恢复摘要:
┌─────────────────────────────────┐
│ 恢复详情                        │
├─────────────────────────────────┤
│ 源地址: 0x1234...7890           │
│ 目标网络: Arbitrum              │
│ 恢复时间: 2024-01-15 14:35      │
│ 持续时间: 4 分 23 秒            │
└─────────────────────────────────┘

💰 资产明细:
• 原始总额: $1,495.06
• 服务费: $7.48 (0.5%)
• 网络费用: 已包含
• 最终金额: $1,487.58

🔗 交易哈希:
0xabc123...def456 ✅ 已确认

[在浏览器中查看] [返回菜单]
```

## 💰 费用结构详解

### 服务费计算
服务费按总恢复价值的百分比计算：

- **费率**: 总资产价值的 0.5%
- **最低费用**: $1.00 USDC
- **最高费用**: $100,000,000 USDC（实际上无上限）
- **收费币种**: 仅收取 USDC

### 费用计算示例
```
示例 1: 恢复价值 $100
服务费 = max($100 × 0.5%, $1.00) = $1.00

示例 2: 恢复价值 $1,000
服务费 = $1,000 × 0.5% = $5.00

示例 3: 恢复价值 $10,000
服务费 = $10,000 × 0.5% = $50.00

示例 4: 恢复价值 $100,000
服务费 = $100,000 × 0.5% = $500.00
```

### 费用包含内容
- **资产转换**: 将非 USDC 资产转换为 USDC
- **账户转移**: 在现货和永续合约账户之间转移资产
- **提现处理**: 执行到 Arbitrum 网络的提现
- **网络费用**: 包含所有区块链交易成本
- **技术支持**: 机器人运营和维护成本

### 费用收取流程
1. **计算**: 基于检测到的总资产价值计算费用
2. **扣除**: 在最终提现步骤中自动扣除
3. **透明**: 执行前清楚显示费用金额
4. **一次性**: 一次性费用，无额外收费

### 费用配置
费用结构可通过环境变量配置：
- `SERVICE_FEE_ENABLED`: 启用/禁用费用收取
- `SERVICE_FEE_PERCENTAGE`: 费用百分比（默认 0.5%）
- `SERVICE_FEE_MIN_FEE`: 最低费用金额（默认 $1.00）
- `SERVICE_FEE_MAX_FEE`: 最高费用金额（默认 $100M）
- `SERVICE_FEE_RECIPIENT`: 接收费用的地址

## 🔒 安全实现

### 私钥处理
机器人对私钥管理实施严格的安全措施：

```
🔐 私钥安全:

1. 仅内存存储:
   • 私钥从不写入磁盘
   • 仅在操作期间存储在内存中
   • 完成后自动清除

2. 传输加密:
   • 所有 API 通信使用 HTTPS
   • 私钥在函数间传递时加密
   • 不记录敏感数据

3. 最小暴露:
   • 私钥仅用于签署交易
   • 不执行不必要的操作
   • 每步完成后立即清理
```

### 操作安全
```
🛡️ 安全机制:

1. 输入验证:
   • 使用 viem 库验证地址格式
   • 私钥格式验证
   • 操作前验证资产余额

2. 交易安全:
   • 每个操作在继续前确认
   • 网络故障时自动重试
   • 失败操作的回滚能力

3. API 安全:
   • 专门使用官方 Hyperliquid SDK
   • 遵守速率限制
   • 所有 API 调用的错误处理
```

### 恢复流程安全
```
💎 流程安全:

1. 逐步执行:
   • 每个恢复步骤独立执行
   • 跟踪和记录进度
   • 故障隔离防止级联错误

2. 资产保护:
   • 仅提现到 Arbitrum 网络
   • 提供交易哈希用于验证
   • 维护完整的审计跟踪

3. 错误恢复:
   • 优雅处理部分故障
   • 详细的错误报告
   • 需要时支持手动干预
```

## ⚠️ 重要注意事项

### 操作前要求
1. **稳定网络**: 确保整个过程中有可靠的互联网连接
2. **安全环境**: 在安全、私密的环境中使用机器人
3. **私钥访问**: 准备好源地址的正确私钥
4. **充足时间**: 为完整恢复过程预留 5-15 分钟

### 操作期间
1. **保持连接**: 保持 Telegram 应用打开并连接
2. **避免干扰**: 避免在同一地址上进行其他操作
3. **监控进度**: 注意任何错误消息或输入请求
4. **保持耐心**: 某些步骤可能需要几分钟才能完成

### 操作后验证
1. **检查交易**: 在 Arbitrum 浏览器上验证提现交易
2. **确认到账**: 检查资金是否到达目标地址
3. **保存记录**: 保留交易哈希作为记录
4. **清除数据**: 私钥自动从机器人内存中清除

## 🔧 技术实现

### 恢复算法
机器人遵循标准化的恢复流程：

```
📋 恢复步骤:

1. 资产检测:
   • 查询所有账户类型（现货、永续合约、金库、质押）
   • 计算总 USD 价值
   • 识别转换要求

2. 资产转换:
   • 将非 USDC 现货资产转换为 USDC
   • 平仓永续合约持仓并转换为 USDC
   • 处理金库/质押资产（如果适用）

3. 账户整合:
   • 将所有现货 USDC 转移到永续合约账户
   • 确保所有资产都在永续合约账户中以 USDC 形式存在

4. 最终提现:
   • 计算服务费
   • 执行到 Arbitrum 的提现
   • 提供交易确认
```

### 支持的网络
- **源**: Hyperliquid（主网或测试网）
- **目标**: Arbitrum One（主网）或 Arbitrum Sepolia（测试网）
- **资产**: 仅 USDC（所有资产在提现前转换为 USDC）

### 错误处理
- **网络问题**: 指数退避自动重试
- **API 故障**: 优雅降级和错误报告
- **部分故障**: 详细状态报告以便手动干预
- **交易失败**: 重试机制并通知用户

## 🆘 故障排除

### 常见问题及解决方案

#### Q: 私钥验证失败
```
❌ 可能原因:
1. 私钥格式无效
2. 私钥与地址不匹配
3. 密钥长度不正确（不是 64 位十六进制字符）

✅ 解决方案:
1. 确保私钥是 64 位十六进制字符
2. 如果存在，请移除 0x 前缀
3. 验证私钥对应正确地址
4. 尝试将密钥导入钱包以验证其有效性
```

#### Q: 资产转换失败
```
❌ 可能原因:
1. 资产流动性不足
2. 市场波动导致滑点
3. Hyperliquid API 临时问题

✅ 解决方案:
1. 几分钟后重试操作
2. 检查资产是否活跃交易
3. 如果问题持续，请联系支持
```

#### Q: 提现交易失败
```
❌ 可能原因:
1. Arbitrum 网络拥堵
2. 网络费用余额不足
3. 临时 API 连接问题

✅ 解决方案:
1. 等待网络状况改善
2. 确保有足够的 USDC 余额支付费用
3. 重试提现操作
4. 在 Arbitrum 浏览器上检查交易状态
```

#### Q: 恢复过程卡住
```
❌ 可能原因:
1. 网络连接问题
2. Hyperliquid API 速率限制
3. 大额交易需要更多时间

✅ 解决方案:
1. 检查您的互联网连接
2. 等待当前步骤完成（最多 5 分钟）
3. 过程中不要关闭 Telegram
4. 如果卡住超过 10 分钟，请联系支持
```

### 获取帮助
如果您遇到上述未涵盖的问题：

1. **使用机器人反馈**: 通过机器人内置的反馈系统发送反馈
2. **提供详情**: 包括地址、错误消息和问题发生时间
3. **交易哈希**: 如果可用，请提供任何交易哈希
4. **截图**: 错误消息的截图可能会有帮助

### 恢复限制
- **最低恢复**: 需要 $0.01 总价值
- **支持的资产**: 仅限有可用市场价格的资产
- **网络依赖**: 需要 Hyperliquid 和 Arbitrum 网络都正常运行
- **API 可用性**: 依赖于 Hyperliquid API 正常运行时间


